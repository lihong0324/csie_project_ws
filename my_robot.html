<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Robot Control Interface</title>

  <!-- ===== ç‰ˆé¢ï¼†å…ƒä»¶æ¨£å¼ ===== -->
  <style>
    /* === ç‰ˆé¢é…ç½®ï¼ˆä¿ç•™åŸæœ¬æ¨£å¼ï¼‰ === */
    body{font-family:Arial,Helvetica,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:0;box-sizing:border-box;transform:scale(.8);transform-origin:center top}
    .page-container{width:125%;display:flex;flex-direction:column;align-items:center;padding-bottom:40px}
    h1{margin-bottom:20px}

    /* === æ”å½±æ©Ÿå€ === */
    .camera-container{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;margin-bottom:20px;width:100%;max-width:1400px}
    .camera-feed{border:2px solid #000;border-radius:20px;overflow:hidden;position:relative}
    .camera-label,.view-toggle-hint{position:absolute;background:rgba(0,0,0,.7);color:#fff;padding:5px 10px;border-radius:5px;font-size:14px;z-index:10}
    .camera-label{top:10px;left:10px}.view-toggle-hint{bottom:10px;right:10px}
    #main-camera-view{position:relative;width:640px;height:360px}
    #standard-camera,#thermal-camera{width:100%;height:100%;position:absolute;top:0;left:0}
    #thermal-camera{display:none}

    /* === æ–¹å‘éµæ§åˆ¶å€ === */
    #control-panel{display:grid;grid-template-columns:repeat(3,100px);grid-template-rows:repeat(3,100px);gap:10px;justify-items:center;align-items:center;margin-bottom:20px}
    .control-btn{width:80px;height:80px;border-radius:50%;font-size:24px;text-align:center;line-height:80px;background:#8cbee9d2;border:1px solid #000;cursor:pointer;transition:background-color .2s;display:flex;justify-content:center;align-items:center}
    .control-btn.active{background:#4682b4}
    #up{grid-column:2;grid-row:1}#left{grid-column:1;grid-row:2}#down{grid-column:2;grid-row:3}#right{grid-column:3;grid-row:2}

    /* === æ“ä½œæŒ‰éˆ• === */
    .button-container{display:flex;gap:15px;margin-top:20px}
    .action-btn{padding:10px 20px;font-size:18px;background:#f0ad4e;border:none;border-radius:5px;cursor:pointer;transition:background-color .2s,opacity .3s}
    .action-btn.manual-mode{background:#2ecc71}
    #reset-btn{background:#5bc0de}#launch-btn{background:#d9534f}

    /* === ç‹€æ…‹é¢æ¿ === */
    .status-panel{width:100%;max-width:800px;margin-top:20px;display:flex;flex-wrap:wrap;justify-content:space-around;gap:20px}
    .status-card{background:#f5f5f5;border-radius:10px;padding:15px;min-width:200px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .status-card h3{margin-top:0;border-bottom:1px solid #ddd;padding-bottom:5px}
    .status-indicator{display:flex;align-items:center;margin:10px 0}
    .indicator-light{width:12px;height:12px;border-radius:50%;margin-right:10px}
    .green{background:#2ecc71}.red{background:#e74c3c}.yellow{background:#f1c40f}

    /* === å…¶ä»–æç¤º === */
    #servo-status{margin-top:10px;padding:10px;border-radius:5px;text-align:center;background:#f8f9fa;display:none}
  </style>
</head>
<body>
  <div class="page-container">
    <h1>ROS 2 Robot Control</h1>

    <!-- ===== æ”å½±æ©Ÿç•«é¢ ===== -->
    <div class="camera-container">
      <div class="camera-feed">
        <div id="camera-mode-label" class="camera-label">æ¨™æº–æ”å½±æ©Ÿ</div>
        <div class="view-toggle-hint">æŒ‰ ã€Œ1ã€ éµåˆ‡æ›ç†±æˆåƒ</div>
        <div id="main-camera-view">
          <img id="standard-camera" src="" alt="æ©Ÿå™¨äººè¦–è§’" />
          <img id="thermal-camera"  src="" alt="ç†±æˆåƒè¦–è§’" />
        </div>
      </div>
    </div>

    <!-- ===== ç§»å‹•æ§åˆ¶ ===== -->
    <div id="control-panel">
      <button id="up"    class="control-btn">â–²</button>
      <button id="left"  class="control-btn">â—€</button>
      <button id="down"  class="control-btn">â–¼</button>
      <button id="right" class="control-btn">â–º</button>
    </div>

    <!-- ===== æ“ä½œæŒ‰éˆ• ===== -->
    <div class="button-container">
      <button id="toggle-btn" class="action-btn">åˆ‡æ›åˆ°æ‰‹å‹•æ§åˆ¶</button>
      <button id="reset-btn"  class="action-btn">æ­¸ä½</button>
      <button id="launch-btn" class="action-btn">ç™¼å°„</button>
    </div>

    <!-- ===== ç™¼å°„ï¼æ­¸ä½å›é¥‹ ===== -->
    <div id="servo-status"></div>

    <!-- ===== ç‹€æ…‹é¢æ¿ ===== -->
    <div class="status-panel">
      <!-- ç«ç„°åµæ¸¬ -->
      <div class="status-card">
        <h3>ç«ç„°åµæ¸¬</h3>
        <div class="status-indicator">
          <div id="flame-indicator" class="indicator-light red"></div>
          <span id="flame-status">æœªåµæ¸¬åˆ°ç«ç„°</span>
        </div>
      </div>

      <!-- ç†±æˆåƒ -->
      <div class="status-card">
        <h3>ç†±æˆåƒæ•¸æ“š</h3>
        <div class="status-indicator">
          <span>æœ€é«˜æº«åº¦ï¼š</span>
          <span id="max-temp" class="indicator-light" style="background:none;width:auto;height:auto;margin:0;font-weight:bold">0 Â°C</span>
        </div>
      </div>

      <!-- ç™¼å°„å™¨ç‹€æ…‹ -->
      <div class="status-card">
        <h3>ç™¼å°„å™¨ç‹€æ…‹</h3>
        <div class="status-indicator">
          <div id="launcher-indicator" class="indicator-light green"></div>
          <span id="launcher-status">æ­¸ä½</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== roslib.js ===== -->
  <script src="https://unpkg.com/roslib/build/roslib.min.js"></script>

  <script>
    /* ---------- API ç«¯é» ---------- */
    const API_ENDPOINTS = {
      SERVO_CONTROL: 'http://192.168.1.107:5001',
      ROS_BRIDGE   : 'ws://172.20.10.2:9090',
      VIDEO_FEED   : 'http://192.168.0.103:5000'
    };

    /* ---------- æ”å½±æ©Ÿä¾†æº ---------- */
    document.getElementById('standard-camera').src = `${API_ENDPOINTS.VIDEO_FEED}/video_feed_raw`;
    document.getElementById('thermal-camera' ).src = `${API_ENDPOINTS.VIDEO_FEED}/video_feed_thermal`;

    /* ---------- roslib é€£ç·š ---------- */
    const ros = new ROSLIB.Ros({ url: API_ENDPOINTS.ROS_BRIDGE });
    ros.on('connection', () => console.log('âœ” å·²é€£æ¥ ROS'));
    ros.on('error'     , e => console.error('âœ– ROS é€£ç·šéŒ¯èª¤ï¼š', e));
    ros.on('close'     , () => console.warn('âš  èˆ‡ ROS é€£ç·šé—œé–‰'));

    /* ---------- /cmd_vel topic ---------- */
    const cmdVel = new ROSLIB.Topic({
      ros : ros,
      name: '/cmd_vel',
      messageType: 'geometry_msgs/Twist'
    });
    const twist = new ROSLIB.Message({ linear:{x:0,y:0,z:0}, angular:{x:0,y:0,z:0} });

    /* ---------- å…¶ä»– ROS topic ---------- */
    const flameDetection = new ROSLIB.Topic({ ros, name:'/flame_detection', messageType:'std_msgs/Bool' });
    const thermalData    = new ROSLIB.Topic({ ros, name:'/thermal_data',    messageType:'std_msgs/String' });

    /* ---------- UI ç‹€æ…‹ ---------- */
    let manualControl = false;
    let lastActiveBtn = null;
    let activeKey     = null;
    let thermalOn     = false;

    /* ---------- å·¥å…·å‡½å¼ ---------- */
    function showServoStatus(msg, ok=true){
      const div = document.getElementById('servo-status');
      div.textContent = msg;
      div.style.display = 'block';
      div.style.backgroundColor = ok ? '#d4edda' : '#f8d7da';
      div.style.color = ok ? '#155724' : '#721c24';
      setTimeout(()=>div.style.display='none', 5000);
    }
    function setLauncherStatus(state){
      const ind  = document.getElementById('launcher-indicator');
      const text = document.getElementById('launcher-status');
      text.textContent = state;
      ind.className    = 'indicator-light ' + (state==='æ­¸ä½' ? 'green' : state==='ç™¼å°„' ? 'red' : 'yellow');
    }
    function resetBtnStyles(){
      ['up','down','left','right'].forEach(id => document.getElementById(id).classList.remove('active'));
      lastActiveBtn = null;
    }
    function toggleCamera(){
      thermalOn = !thermalOn;
      document.getElementById('thermal-camera').style.display  = thermalOn ? 'block':'none';
      document.getElementById('standard-camera').style.display = thermalOn ? 'none' :'block';
      document.getElementById('camera-mode-label').textContent = thermalOn ? 'ç†±æˆåƒæ”å½±æ©Ÿ' : 'æ¨™æº–æ”å½±æ©Ÿ';
    }

    /* ---------- ç™¼å°„å™¨ API ---------- */
    function resetLauncher(){
      fetch(`${API_ENDPOINTS.SERVO_CONTROL}/reset`,{method:'POST',headers:{'Content-Type':'application/json'}})
        .then(r=>r.json()).then(d=>{
          showServoStatus(d.message);
          setLauncherStatus('æ­¸ä½');
          flashBtn('reset-btn');
        }).catch(e=>{
          console.error(e);showServoStatus('æ­¸ä½å¤±æ•—',false);
        });
    }
    function launchLauncher(){
      fetch(`${API_ENDPOINTS.SERVO_CONTROL}/launch`,{method:'POST',headers:{'Content-Type':'application/json'}})
        .then(r=>r.json()).then(d=>{
          showServoStatus(d.message);
          setLauncherStatus('ç™¼å°„');
          flashBtn('launch-btn');
        }).catch(e=>{
          console.error(e);showServoStatus('ç™¼å°„å¤±æ•—',false);
        });
    }
    function flashBtn(id){
      const btn=document.getElementById(id);
      btn.style.opacity='.7';setTimeout(()=>btn.style.opacity='1',300);
    }

    /* ---------- ç§»å‹•æ§åˆ¶ ---------- */
    function move(dir, btn){
      if(lastActiveBtn===btn){ stop(); return; }
      resetBtnStyles();
      switch(dir){
        case 'up'   : twist.linear.x =  0.5; twist.angular.z = 0;   break;
        case 'down' : twist.linear.x = -0.5; twist.angular.z = 0;   break;
        case 'left' : twist.linear.x = 0;    twist.angular.z = 0.5; break;
        case 'right': twist.linear.x = 0;    twist.angular.z =-0.5; break;
      }
      cmdVel.publish(twist);
      btn.classList.add('active'); lastActiveBtn = btn;
    }
    function stop(){
      twist.linear.x = twist.angular.z = 0;
      cmdVel.publish(twist);
      resetBtnStyles();
    }

    /* ---------- äº‹ä»¶ç¹«çµ ---------- */
    ['up','down','left','right'].forEach(id=>{
      document.getElementById(id).addEventListener('click',()=>move(id,document.getElementById(id)));
    });
    document.getElementById('reset-btn' ).addEventListener('click', resetLauncher);
    document.getElementById('launch-btn').addEventListener('click', launchLauncher);

    /* --- éµç›¤ --- */
    window.addEventListener('keydown',e=>{
      if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','1'].includes(e.key))e.preventDefault();
    });
    document.addEventListener('keydown',e=>{
      if(activeKey) return;
      switch(e.key){
        case '1'        : toggleCamera(); break;
        case 'ArrowUp'  : activeKey='ArrowUp';   move('up',   up);    break;
        case 'ArrowDown': activeKey='ArrowDown'; move('down', down);  break;
        case 'ArrowLeft': activeKey='ArrowLeft'; move('left', left);  break;
        case 'ArrowRight':activeKey='ArrowRight';move('right',right); break;
        case 'r': resetLauncher(); break;
        case 'l': launchLauncher(); break;
      }
    });
    document.addEventListener('keyup',e=>{
      if(e.key===activeKey){ stop(); activeKey=null; }
    });

    /* ---------- æ‰‹å‹•ï¼è‡ªå‹•åˆ‡æ› ---------- */
    document.getElementById('toggle-btn').addEventListener('click',()=>{
      manualControl = !manualControl;
      new ROSLIB.Topic({ros,name:'/manual_control',messageType:'std_msgs/Bool'})
        .publish(new ROSLIB.Message({data:manualControl}));
      const tBtn=document.getElementById('toggle-btn');
      tBtn.textContent = manualControl ? 'åˆ‡æ›åˆ°è‡ªå‹•å°èˆª' : 'åˆ‡æ›åˆ°æ‰‹å‹•æ§åˆ¶';
      tBtn.classList.toggle('manual-mode', manualControl);
    });

    /* ---------- ROS è³‡æ–™è¨‚é–± ---------- */
    flameDetection.subscribe(msg=>{
      const ind = document.getElementById('flame-indicator');
      const txt = document.getElementById('flame-status');
      if(msg.data){
        ind.className='indicator-light red';
        txt.textContent='åµæ¸¬åˆ°ç«ç„°!';
        txt.style.color='#e74c3c'; txt.style.fontWeight='bold';
      }else{
        ind.className='indicator-light green';
        txt.textContent='æœªåµæ¸¬åˆ°ç«ç„°';
        txt.style.color=''; txt.style.fontWeight='';
      }
    });
    thermalData.subscribe(msg=>{
      try{
        const data=JSON.parse(msg.data);
        if(data.max_temp!==undefined)
          document.getElementById('max-temp').textContent = data.max_temp.toFixed(1)+' Â°C';
      }catch(err){ console.error('ç†±æˆåƒè³‡æ–™è§£æéŒ¯èª¤ï¼š',err); }
    });

    /* ---------- åˆå§‹åŒ– ---------- */
    window.addEventListener('load',()=>{
      document.getElementById('toggle-btn').textContent='åˆ‡æ›åˆ°æ‰‹å‹•æ§åˆ¶';
      setLauncherStatus('æ­¸ä½');          // é è¨­é¡¯ç¤ºæ­¸ä½
      console.log('ğŸ“‹ ä»‹é¢å·²è¼‰å…¥');
    });
  </script>
</body>
</html>
